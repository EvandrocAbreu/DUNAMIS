<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipulado Dunamis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background: #F5F5F5;
            color: #333;
            line-height: 1.6;
        }

        header {
            background: #B22222;
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        header h1 {
            font-size: 24px;
        }

        nav {
            margin-top: 1rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-size: 16px;
        }

        nav a:hover {
            color: #FFDAD5;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .main-section {
            flex: 2;
        }

        .sidebar {
            flex: 1;
            background: #FFDAD5;
            padding: 15px;
            border-radius: 8px;
        }

        h2 {
            color: #B22222;
            margin-bottom: 15px;
        }

        .search-bar {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #D3D3D3;
            border-radius: 5px;
        }

        .family-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .family-header {
            padding: 15px;
            cursor: pointer;
            background: #D3D3D3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-content {
            display: none;
            padding: 15px;
        }

        .member {
            border-bottom: 1px solid #D3D3D3;
            padding: 10px 0;
        }

        .member img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #B22222;
            color: white;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #C14B4B;
        }

        .btn-add {
            margin: 15px 0;
        }

        #family-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #family-form input, #family-form select {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #D3D3D3;
            border-radius: 5px;
        }

        .month-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .month-btn {
            padding: 5px 10px;
            border: 1px solid #B22222;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .month-btn.active {
            background: #B22222;
            color: white;
        }

        #stats-section ul {
            list-style: none;
        }

        #stats-section li {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            nav {
                display: flex;
                flex-direction: column;
            }

            nav a {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Discipulado Dunamis</h1>
        <nav>
            <a href="#" id="nav-home">Início</a>
            <a href="#" id="nav-families">Famílias</a>
            <a href="#" id="nav-birthdays">Aniversariantes</a>
            <a href="#" id="nav-stats">Estatísticas</a> <!-- Nova opção no menu -->
        </nav>
    </header>

    <div class="container">
        <section class="main-section" id="home-section">
            <h2>Bem-vindo ao Discipulado Dunamis</h2>
            <p>Gerencie as famílias e acompanhe os aniversariantes do mês.</p>
        </section>

        <section class="main-section" id="families-section" style="display: none;">
            <h2>Famílias Cadastradas</h2>
            <input type="text" class="search-bar" placeholder="Buscar por nome..." onkeyup="searchFamilies()">
            <button class="btn btn-add" onclick="showFamilyForm()">Adicionar Nova Família</button>
            <input type="file" id="excel-upload" accept=".xlsx, .xls" onchange="handleExcelUpload(event)">
            <div id="families-list"></div>
        </section>

        <section class="sidebar" id="birthdays-section" style="display: none;">
            <h2>Aniversariantes do Mês</h2>
            <div class="month-filter" id="month-filter"></div>
            <div id="birthdays-list"></div>
        </section>

        <!-- Nova seção para estatísticas -->
        <section class="main-section" id="stats-section" style="display: none;">
            <h2>Estatísticas</h2>
            <div id="stats-content"></div>
        </section>
    </div>

    <div id="family-form">
        <h3>Adicionar/Editar Família</h3>
        <input type="text" id="family-name" placeholder="Nome da Família">
        <input type="text" id="member-name" placeholder="Nome do Membro">
        <input type="tel" id="member-phone" placeholder="Telefone (ex.: (11) 98765-4321)">
        <input type="text" id="member-address" placeholder="Endereço">
        <input type="date" id="member-birthdate">
        <select id="member-frequency">
            <option value="Regular">Regular</option>
            <option value="Ocasional">Ocasional</option>
            <option value="Ausente">Ausente</option>
        </select>
        <select id="member-marital-status">
            <option value="Solteiro">Solteiro</option>
            <option value="Casado">Casado</option>
            <option value="Divorciado">Divorciado</option>
            <option value="Viúvo">Viúvo</option>
        </select>
        <!-- Novo campo Sexo no formulário -->
        <select id="member-sex">
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
        </select>
        <input type="file" id="member-photo" accept="image/*">
        <button class="btn" onclick="saveFamily()">Salvar</button>
        <button class="btn" onclick="hideFamilyForm()">Cancelar</button>
    </div>

    <script>
        let families = JSON.parse(localStorage.getItem('families')) || [];
        const months = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        function showSection(section) {
            document.querySelectorAll('.main-section, .sidebar').forEach(el => el.style.display = 'none');
            document.getElementById(`${section}-section`).style.display = 'block';
            if (section === 'families') loadFamilies();
            if (section === 'birthdays') loadBirthdays();
            if (section === 'stats') loadStats();
        }

        document.getElementById('nav-home').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('home');
        });
        document.getElementById('nav-families').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('families');
        });
        document.getElementById('nav-birthdays').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('birthdays');
        });
        document.getElementById('nav-stats').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('stats');
        });

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', dateNF: 'dd/mm/yyyy' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                processExcelData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            const newFamilies = {};
            data.forEach(row => {
                const familyName = row['Nome da Família'] || 'Família Sem Nome';
                let birthdate = row['Data de Nascimento'];

                if (typeof birthdate === 'number') {
                    const date = XLSX.SSF.parse_date_code(birthdate);
                    birthdate = `${String(date.d).padStart(2, '0')}/${String(date.m).padStart(2, '0')}/${date.y}`;
                } else if (birthdate && typeof birthdate === 'string') {
                    const parts = birthdate.split('/');
                    if (parts.length === 3) {
                        birthdate = `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
                    } else {
                        birthdate = '';
                    }
                } else {
                    birthdate = '';
                }

                const member = {
                    name: row['Nome do Membro'] || '',
                    phone: row['Telefone'] || '',
                    address: row['Endereço'] || '',
                    birthdate: birthdate,
                    frequency: row['Frequência'] || 'Regular',
                    maritalStatus: row['Estado Civil'] || 'Não informado',
                    sex: row['Sexo'] || 'Não informado', // Novo campo consumido da planilha
                    photo: row['Foto'] || ''
                };

                if (!newFamilies[familyName]) {
                    newFamilies[familyName] = { name: familyName, members: [] };
                }
                newFamilies[familyName].members.push(member);
            });

            families = Object.values(newFamilies);
            localStorage.setItem('families', JSON.stringify(families));
            loadFamilies();
            loadBirthdays();
            loadStats();
        }

        function loadFamilies() {
            const list = document.getElementById('families-list');
            list.innerHTML = '';
            families.forEach((family, index) => {
                const card = document.createElement('div');
                card.className = 'family-card';
                card.innerHTML = `
                    <div class="family-header" onclick="toggleFamily(this)">
                        ${family.name}
                        <div>
                            <button class="btn" onclick="editFamily(${index}); event.stopPropagation()">Editar</button>
                            <button class="btn" onclick="deleteFamily(${index}); event.stopPropagation()">Excluir</button>
                        </div>
                    </div>
                    <div class="family-content">
                        ${family.members.map(member => `
                            <div class="member">
                                <img src="${member.photo || 'https://via.placeholder.com/150'}" alt="Foto">
                                <p><strong>Nome:</strong> ${member.name}</p>
                                <p><strong>Telefone:</strong> ${member.phone}</p>
                                <p><strong>Endereço:</strong> ${member.address}</p>
                                <p><strong>Data de Nascimento:</strong> ${member.birthdate || 'N/A'} (Idade: ${calculateAge(member.birthdate)})</p>
                                <p><strong>Frequência:</strong> ${member.frequency}</p>
                                <p><strong>Estado Civil:</strong> ${member.maritalStatus}</p>
                                <p><strong>Sexo:</strong> ${member.sex}</p> <!-- Novo campo exibido -->
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function toggleFamily(header) {
            const content = header.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }

        function calculateAge(birthdate) {
            if (!birthdate) return 'N/A';
            const [day, month, year] = birthdate.split('/').map(Number);
            const today = new Date();
            const birth = new Date(year, month - 1, day);
            let age = today.getFullYear() - birth.getFullYear();
            if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function showFamilyForm() {
            document.getElementById('family-form').style.display = 'block';
        }

        function hideFamilyForm() {
            document.getElementById('family-form').style.display = 'none';
            clearForm();
        }

        function clearForm() {
            document.getElementById('family-name').value = '';
            document.getElementById('member-name').value = '';
            document.getElementById('member-phone').value = '';
            document.getElementById('member-address').value = '';
            document.getElementById('member-birthdate').value = '';
            document.getElementById('member-frequency').value = 'Regular';
            document.getElementById('member-marital-status').value = 'Solteiro';
            document.getElementById('member-sex').value = 'Masculino';
            document.getElementById('member-photo').value = '';
        }

        function saveFamily() {
            const familyName = document.getElementById('family-name').value;
            const member = {
                name: document.getElementById('member-name').value,
                phone: document.getElementById('member-phone').value,
                address: document.getElementById('member-address').value,
                birthdate: new Date(document.getElementById('member-birthdate').value).toLocaleDateString('pt-BR'),
                frequency: document.getElementById('member-frequency').value,
                maritalStatus: document.getElementById('member-marital-status').value,
                sex: document.getElementById('member-sex').value, // Novo campo salvo
                photo: ''
            };

            const photoInput = document.getElementById('member-photo');
            if (photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = () => {
                    member.photo = reader.result;
                    addOrUpdateFamily(familyName, member);
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                addOrUpdateFamily(familyName, member);
            }
        }

        function addOrUpdateFamily(familyName, member) {
            const existingFamily = families.find(f => f.name === familyName);
            if (existingFamily) {
                existingFamily.members.push(member);
            } else {
                families.push({ name: familyName, members: [member] });
            }
            localStorage.setItem('families', JSON.stringify(families));
            loadFamilies();
            loadBirthdays();
            loadStats();
        }

        function editFamily(index) {
            const family = families[index];
            document.getElementById('family-name').value = family.name;
            showFamilyForm();
        }

        function deleteFamily(index) {
            if (confirm('Tem certeza que deseja excluir esta família?')) {
                families.splice(index, 1);
                localStorage.setItem('families', JSON.stringify(families));
                loadFamilies();
                loadBirthdays();
                loadStats();
            }
        }

        function searchFamilies() {
            const query = document.querySelector('.search-bar').value.toLowerCase();
            const filtered = families.filter(family => 
                family.name.toLowerCase().includes(query) || 
                family.members.some(m => m.name.toLowerCase().includes(query))
            );
            const list = document.getElementById('families-list');
            list.innerHTML = '';
            filtered.forEach((family, index) => {
                const card = document.createElement('div');
                card.className = 'family-card';
                card.innerHTML = `
                    <div class="family-header" onclick="toggleFamily(this)">
                        ${family.name}
                        <div>
                            <button class="btn" onclick="editFamily(${index}); event.stopPropagation()">Editar</button>
                            <button class="btn" onclick="deleteFamily(${index}); event.stopPropagation()">Excluir</button>
                        </div>
                    </div>
                    <div class="family-content">
                        ${family.members.map(member => `
                            <div class="member">
                                <img src="${member.photo || 'https://via.placeholder.com/150'}" alt="Foto">
                                <p><strong>Nome:</strong> ${member.name}</p>
                                <p><strong>Telefone:</strong> ${member.phone}</p>
                                <p><strong>Endereço:</strong> ${member.address}</p>
                                <p><strong>Data de Nascimento:</strong> ${member.birthdate || 'N/A'} (Idade: ${calculateAge(member.birthdate)})</p>
                                <p><strong>Frequência:</strong> ${member.frequency}</p>
                                <p><strong>Estado Civil:</strong> ${member.maritalStatus}</p>
                                <p><strong>Sexo:</strong> ${member.sex}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function loadBirthdays() {
            const filter = document.getElementById('month-filter');
            const list = document.getElementById('birthdays-list');
            filter.innerHTML = '';
            list.innerHTML = '';

            months.forEach((month, index) => {
                const btn = document.createElement('button');
                btn.className = 'month-btn';
                btn.textContent = month.slice(0, 3);
                btn.onclick = () => filterBirthdays(index + 1);
                filter.appendChild(btn);
            });

            const currentMonth = new Date().getMonth();
            document.querySelectorAll('.month-btn')[currentMonth].classList.add('active');

            months.forEach((month, monthIndex) => {
                const monthNumber = monthIndex + 1;
                const birthdays = families.flatMap(f => f.members)
                    .filter(m => {
                        if (!m.birthdate) return false;
                        const [_, mMonth] = m.birthdate.split('/');
                        return parseInt(mMonth) === monthNumber;
                    });

                if (birthdays.length > 0) {
                    list.innerHTML += `<h3>${month}</h3>`;
                    birthdays.forEach(member => {
                        list.innerHTML += `<p>${member.name} - ${member.birthdate}</p>`;
                    });
                }
            });
        }

        function filterBirthdays(month) {
            const list = document.getElementById('birthdays-list');
            list.innerHTML = '';

            const birthdays = families.flatMap(f => f.members)
                .filter(m => {
                    if (!m.birthdate) return false;
                    const [_, mMonth] = m.birthdate.split('/');
                    return parseInt(mMonth) === month;
                });

            if (birthdays.length > 0) {
                list.innerHTML = `<h3>${months[month - 1]}</h3>`;
                birthdays.forEach(member => {
                    list.innerHTML += `<p>${member.name} - ${member.birthdate}</p>`;
                });
            } else {
                list.innerHTML = `<p>Nenhum aniversariante em ${months[month - 1]}</p>`;
            }

            document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.month-btn:nth-child(${month})`).classList.add('active');
        }

        // Nova função para carregar estatísticas
        function loadStats() {
            const content = document.getElementById('stats-content');
            const allMembers = families.flatMap(f => f.members);

            // Total de membros cadastrados
            const totalMembers = allMembers.length;

            // Total de menores de 18 anos
            const minors = allMembers.filter(m => {
                const age = calculateAge(m.birthdate);
                return age !== 'N/A' && age < 18;
            }).length;

            // Total por estado civil
            const maritalStatusCount = {};
            allMembers.forEach(m => {
                maritalStatusCount[m.maritalStatus] = (maritalStatusCount[m.maritalStatus] || 0) + 1;
            });

            // Total por sexo
            const sexCount = {};
            allMembers.forEach(m => {
                sexCount[m.sex] = (sexCount[m.sex] || 0) + 1;
            });

            // Total de membros com mais de 60 anos
            const seniors = allMembers.filter(m => {
                const age = calculateAge(m.birthdate);
                return age !== 'N/A' && age > 60;
            }).length;

            content.innerHTML = `
                <ul>
                    <li><strong>Total de Membros Cadastrados:</strong> ${totalMembers}</li>
                    <li><strong>Menores de 18 anos:</strong> ${minors}</li>
                    <li><strong>Mais de 60 anos:</strong> ${seniors}</li>
                    <li><strong>Total por Estado Civil:</strong>
                        <ul>
                            ${Object.entries(maritalStatusCount).map(([status, count]) => `<li>${status}: ${count}</li>`).join('')}
                        </ul>
                    </li>
                    <li><strong>Total por Sexo:</strong>
                        <ul>
                            ${Object.entries(sexCount).map(([sex, count]) => `<li>${sex}: ${count}</li>`).join('')}
                        </ul>
                    </li>
                </ul>
            `;
        }

        showSection('home');
    </script>
</body>
</html>